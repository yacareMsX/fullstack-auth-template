<mvc:View controllerName="invoice.app.controller.france.FranceInvoiceDetail"
    xmlns="sap.m"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns:core="sap.ui.core"
    xmlns:layout="sap.ui.layout"
    xmlns:form="sap.ui.layout.form">

    <Page title="{i18n>invoiceDetail}" showNavButton="true" navButtonPress="onNavBack" enableScrolling="true">

        <content>
            <layout:Splitter height="100%" width="100%">
                <layout:contentAreas>
                    <!-- LEFT PANE: FORM -->
                    <layout:VerticalLayout width="100%" class="sapUiContentPadding">
                        <layout:layoutData>
                            <layout:SplitterLayoutData size="auto" resizable="true"/>
                        </layout:layoutData>

                        <!-- HEADER SECTIONS: FROM / TO -->
                        <layout:Grid defaultSpan="L6 M6 S12" class="sapUiMediumMarginBottom">

                            <!-- FROM SECTION -->
                            <VBox class="cardLikeSection">
                                <Title text="{i18n>from}" level="H3" class="sapUiSmallMarginBottom sectionHeader"/>

                                <Label text="{i18n>name}" design="Bold"/>
                                <Input value="{detail>/emisor_nombre}" placeholder="{i18n>companyName}" class="sapUiSmallMarginBottom" editable="false"/>

                                <Label text="{i18n>address}" design="Bold"/>
                                <TextArea value="{detail>/emisor_direccion}" rows="4" width="100%" placeholder="{i18n>addressPlaceholder}" editable="false"/>
                            </VBox>

                            <!-- TO SECTION -->
                            <VBox class="cardLikeSection">
                                <Title text="{i18n>to}" level="H3" class="sapUiSmallMarginBottom sectionHeader"/>

                                <Label text="{i18n>selectClient}" design="Bold"/>
                                <ComboBox width="100%" items="{clients>/}" selectedKey="{detail>/receptor_id}" placeholder="{i18n>chooseClient}" change="onClientSelect" class="sapUiSmallMarginBottom" editable="false">
                                    <core:Item key="{clients>id}" text="{clients>name}"/>
                                </ComboBox>

                                <Label text="{i18n>name}" design="Bold"/>
                                <Input value="{detail>/receptor_nombre}" placeholder="{i18n>clientName}" class="sapUiSmallMarginBottom" editable="false"/>

                                <Label text="{i18n>address}" design="Bold"/>
                                <TextArea value="{detail>/receptor_direccion}" rows="3" width="100%" placeholder="{i18n>clientAddress}" editable="false"/>
                            </VBox>
                        </layout:Grid>

                        <!-- INVOICE DETAILS SECTION -->
                        <VBox class="cardLikeSection sapUiMediumMarginBottom">
                            <Title text="{i18n>invoiceDetails}" level="H3" class="sapUiMediumMarginBottom sectionHeader"/>

                            <layout:Grid defaultSpan="L4 M6 S12" vSpacing="1" hSpacing="1">
                                <!-- Row 1 -->
                                <VBox>
                                    <Label text="{i18n>invoiceType}" design="Bold"/>
                                    <ComboBox width="100%" selectedKey="{detail>/tipo_factura}" editable="false">
                                        <core:Item key="F1" text="Factura - F1"/>
                                        <core:Item key="F2" text="Factura Simplificada - F2"/>
                                        <core:Item key="R1" text="Factura Rectificativa - R1"/>
                                    </ComboBox>
                                </VBox>

                                <VBox>
                                    <Label text="{i18n>invoiceNumber}" design="Bold"/>
                                    <Input value="{detail>/numero}" placeholder="INV-XXXX" editable="false"/>
                                </VBox>

                                <VBox>
                                    <Label text="{i18n>issueDate}" design="Bold"/>
                                    <DatePicker value="{
                                            path: 'detail>/fecha_emision',
                                            type: 'sap.ui.model.type.Date',
                                            formatOptions: { pattern: 'dd/MM/yyyy' }
                                        }" width="100%" editable="false"/>
                                </VBox>

                                <VBox>
                                    <Label text="{i18n>operationDate}" design="Bold"/>
                                    <DatePicker value="{
                                            path: 'detail>/fecha_operacion', 
                                            type: 'sap.ui.model.type.Date', 
                                            formatOptions: { pattern: 'dd/MM/yyyy' }
                                        }" width="100%" editable="false"/>
                                </VBox>

                                <!-- Row 2 -->
                                <VBox></VBox>                                <!-- Empty slot for spacing if needed or just flow -->

                                <!-- Row 3 (Status) -->
                                <VBox>
                                    <Label text="{i18n>status}" design="Bold"/>
                                    <ComboBox width="100%" selectedKey="{detail>/estado}" selectionChange="onChangeStatus">
                                        <core:Item key="BORRADOR" text="{i18n>statusDraft}"/>
                                        <core:Item key="EMITIDA" text="{i18n>statusIssued}"/>
                                        <core:Item key="ENVIADA" text="{i18n>statusSent}"/>
                                        <core:Item key="PAGADA" text="{i18n>statusPaid}"/>
                                        <core:Item key="PENDIENTE" text="{i18n>statusPending}"/>
                                        <core:Item key="CANCELADA" text="Cancelada"/>
                                    </ComboBox>
                                </VBox>
                            </layout:Grid>
                        </VBox>

                        <!-- PAYMENT DETAILS SECTION -->
                        <VBox class="cardLikeSection sapUiMediumMarginBottom">
                            <Title text="{i18n>paymentDetail}" level="H3" class="sapUiMediumMarginBottom sectionHeader"/>
                            <layout:Grid defaultSpan="L4 M6 S12" vSpacing="1" hSpacing="1">
                                <!-- Row 1 (Matches Form) -->
                                <VBox>
                                    <Label text="{i18n>paymentTerms}" design="Bold"/>
                                    <ComboBox width="100%" selectedKey="{detail>/condiciones_pago}" editable="false">
                                        <core:Item key="Net 30" text="Net 30"/>
                                        <core:Item key="Net 60" text="Net 60"/>
                                        <core:Item key="Immediate" text="Immediate"/>
                                    </ComboBox>
                                </VBox>

                                <VBox>
                                    <Label text="{i18n>paymentDate}" design="Bold"/>
                                    <DatePicker value="{
                                            path: 'detail>/fecha_pago',
                                            type: 'sap.ui.model.type.Date',
                                            formatOptions: { pattern: 'dd/MM/yyyy' }
                                        }" width="100%" editable="false"/>
                                </VBox>

                                <VBox>
                                    <Label text="{i18n>currency}" design="Bold"/>
                                    <ComboBox width="100%" selectedKey="{detail>/moneda}" editable="false">
                                        <core:Item key="EUR" text="EUR"/>
                                        <core:Item key="USD" text="USD"/>
                                        <core:Item key="GBP" text="GBP"/>
                                    </ComboBox>
                                </VBox>

                                <!-- Row 2 (Extra Read-Only Info Removed to match Form) -->
                            </layout:Grid>
                        </VBox>

                        <!-- TAX INFORMATION SECTION -->
                        <VBox class="cardLikeSection sapUiMediumMarginBottom">
                            <Title text="{i18n>taxInformation}" level="H3" class="sapUiMediumMarginBottom sectionHeader"/>
                            <layout:Grid defaultSpan="L6 M6 S12">
                                <VBox>
                                    <Label text="{i18n>retention}"/>
                                    <ComboBox width="100%" selectedKey="{detail>/retencion}" placeholder="{i18n>selectRetention}" editable="false">
                                        <core:Item key="0" text="{i18n>noRetention}"/>
                                        <core:Item key="7" text="IRPF (7%)"/>
                                        <core:Item key="15" text="IRPF (15%)"/>
                                    </ComboBox>
                                </VBox>
                                <VBox>
                                    <!-- Spacer for removed VAT -->
                                </VBox>
                            </layout:Grid>
                        </VBox>

                        <!-- Line Items Table -->
                        <Panel headerText="{i18n>lineItems}" class="sapUiMediumMarginBottom cardLikeSection">
                            <Table items="{detail>/lineas}" mode="None">
                                <columns>
                                    <Column>
                                        <Text text="{i18n>description}"/>
                                    </Column>
                                    <Column hAlign="End" width="100px">
                                        <Text text="{i18n>qty}"/>
                                    </Column>
                                    <Column hAlign="End" width="120px">
                                        <Text text="{i18n>price}"/>
                                    </Column>
                                    <Column hAlign="End" width="80px">
                                        <Text text="{i18n>tax}"/>
                                    </Column>
                                    <Column hAlign="End" width="140px">
                                        <Text text="{i18n>taxAmount}"/>
                                    </Column>
                                    <Column hAlign="End" width="150px">
                                        <Text text="{i18n>total}"/>
                                    </Column>
                                </columns>
                                <items>
                                    <ColumnListItem>
                                        <cells>
                                            <Text text="{detail>descripcion}"/>
                                            <Text text="{detail>cantidad}"/>
                                            <ObjectNumber number="{detail>precio_unitario}" unit="EUR"/>
                                            <Text text="{detail>porcentaje_impuesto}%"/>
                                            <ObjectNumber number="{detail>importe_impuesto}" unit="EUR"/>
                                            <ObjectNumber number="{detail>total_linea}" unit="EUR" emphasized="true"/>
                                        </cells>
                                    </ColumnListItem>
                                </items>
                            </Table>
                        </Panel>

                        <!-- TOTALS SECTION -->
                        <layout:Grid defaultSpan="L6 M6 S12" class="sapUiMediumMarginBottom">
                            <VBox>                                <!-- Spacer --></VBox>

                            <VBox class="cardLikeSection">
                                <HBox justifyContent="SpaceBetween" class="sapUiTinyMarginBottom">
                                    <Label text="{i18n>taxableBase}" design="Bold" class="sapUiSmallMarginTop"/>
                                    <Title text="{parts:[{path:'detail>/totals/subtotal'}], formatter: '.formatter.currencyValue'}" level="H3"/>
                                </HBox>

                                <!-- Dynamic Tax Breakdown -->
                                <VBox items="{detail>/totals/taxBreakdown}">
                                    <HBox justifyContent="SpaceBetween" class="sapUiTinyMarginBottom">
                                        <Label text="{i18n>tax} {detail>showRate}%" class="sapUiSmallMarginTop"/>
                                        <Text text="{parts:[{path:'detail>amount'}], formatter: '.formatter.currencyValue'}" class="sapUiSmallMarginTop"/>
                                    </HBox>
                                </VBox>

                                <HBox justifyContent="SpaceBetween" class="sapUiSmallMarginBottom">
                                    <Label text="{i18n>retention} ({detail>/retencion}%)" class="sapUiSmallMarginTop negativeValue"/>
                                    <Text text="- {parts:[{path:'detail>/totals/retencion'}], formatter: '.formatter.currencyValue'}" class="sapUiSmallMarginTop negativeValue"/>
                                </HBox>

                                <core:HTML content="&lt;hr style='border:none; border-top:1px solid #ddd; margin: 1rem 0;' /&gt;" />

                                <HBox justifyContent="SpaceBetween">
                                    <Title text="{i18n>total}" level="H2"/>
                                    <Title text="{parts:[{path:'detail>/totals/total'}], formatter: '.formatter.currencyValue'}" level="H2"/>
                                </HBox>
                            </VBox>
                        </layout:Grid>

                    </layout:VerticalLayout>

                    <!-- RIGHT PANE: DOCUMENT VIEWER -->
                    <VBox width="100%" height="100%" class="sapUiContentPadding">
                        <layoutData>
                            <layout:SplitterLayoutData size="{detail>/pdfPanelSize}" resizable="true"/>
                        </layoutData>

                        <Title text="PDF Document" class="sapUiSmallMarginBottom sectionHeader"/>

                        <!-- PDF Viewer Container -->
                        <VBox height="100%" width="100%" renderType="Bare">
                            <core:HTML content='&lt;iframe src="{detail>/pdfSource}" width="100%" height="100%" style="border:none; height: 80vh;"&gt;&lt;/iframe&gt;' visible="{= !!${detail>/pdfSource}}"/>
                        </VBox>
                    </VBox>
                </layout:contentAreas>
            </layout:Splitter>
        </content>

        <footer>
            <OverflowToolbar>
                <ToolbarSpacer/>
                <Button text="View PDF" icon="sap-icon://pdf-attachment" press="onViewPDF"/>
                <Button text="Generate XML UBL 2.1" icon="sap-icon://attachment-text-file" press="onGenerateUBL"/>
                <Button text="{i18n>edit}" type="Emphasized" press="onEdit" icon="sap-icon://edit" enabled="{= ${detail>/estado} === 'BORRADOR'}"/>
                <Button text="{i18n>sendInvoice}" type="Accept" press="onOpenSendWizard" icon="sap-icon://paper-plane" visible="{= ${detail>/estado} === 'BORRADOR'}"/>
            </OverflowToolbar>
        </footer>
    </Page>
</mvc:View>
